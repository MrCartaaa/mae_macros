name: Rust Integrity Guard

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  nightly-ci:
    name: Nightly Clippy + Miri + Audit + Deny + Fmt + Unsafe Checks
    runs-on: ubuntu-latest

    steps:
      # --- Checkout repo ---
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0       # full history needed for git diff

      # --- Cache Cargo dependencies ---
      - name: Cache Cargo registry and git
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # --- Install Rust nightly toolchain ---
      - name: Install Rust Nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          components: clippy,miri,rustfmt

      - name: Install Cargo Miri
        run: rustup component add miri

      # --- Detect changed Rust files ---
      - name: Get changed Rust files
        id: changed_files
        run: |
          echo "::group::Changed Files"

          # Fetch main branch for merge-base
          git fetch origin main

          # Determine base commit for diff
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              BASE_SHA=$(jq -r .pull_request.base.sha < "$GITHUB_EVENT_PATH")
              HEAD_SHA=$(jq -r .pull_request.head.sha < "$GITHUB_EVENT_PATH")
          else
              BASE_SHA=$(jq -r .before < "$GITHUB_EVENT_PATH")
              HEAD_SHA=$(jq -r .after < "$GITHUB_EVENT_PATH")
          fi

          echo "Base SHA for diff: $BASE_SHA"
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '\.rs$' || true)

          echo "Changed Rust files:"
          echo "$CHANGED"
          echo "::endgroup::"

          {
            echo "files<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # --- Optional debug output ---
      - name: Debug environment and changed files
        run: |
          echo "::group::Debug Info"
          echo "GITHUB_EVENT_NAME=${GITHUB_EVENT_NAME}"
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          echo "HEAD commit:"
          git log -1 --oneline
          echo "Main branch HEAD:"
          git fetch origin main
          git log origin/main -1 --oneline
          echo "Merge base:"
          git merge-base HEAD origin/main
          echo "Changed Rust files: ${{ steps.changed_files.outputs.files }}"
          echo "::endgroup::"

      # --- Run Rustfmt check ---
      - name: Run rustfmt
        if: steps.changed_files.outputs.files != ''
        run: cargo +nightly fmt -- --check

      # --- Run Clippy ---
      - name: Run Clippy (strict)
        if: steps.changed_files.outputs.files != ''
        run: |
          cargo +nightly clippy \
            --all-targets \
            --all-features \
            -- -D warnings \
               -D clippy::undocumented_unsafe_blocks

      # --- Run Miri tests ---
      - name: Run Miri Tests
        if: steps.changed_files.outputs.files != ''
        run: cargo +nightly miri test --all-targets --all-features -- --nocapture

      # --- Run Cargo Audit ---
      - name: Run Cargo Audit
        if: steps.changed_files.outputs.files != ''
        run: |
          cargo install cargo-audit --force
          cargo +nightly audit

      # --- Run Cargo Deny ---
      - name: Run Cargo Deny
        if: steps.changed_files.outputs.files != ''
        run: |
          cargo install cargo-deny
          cargo +nightly deny check
